<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dassa.mapper.ManageSaleMapper">
	<select id="manageSaleShopTotalCount" parameterType="com.dassa.vo.ManageSalePageData" resultType="_int">
		select count(*) as cnt from shop_payment_tbl s
		join user_tbl u on(s.user_idx = u.user_idx)
		<trim prefix="where" prefixOverrides="AND|OR">
			<if test='searchType != "" or searchWord != ""'>
				<if test='searchType == "1"'>
					u.user_id like '%'|| #{searchWord} || '%'
				</if>
				<if test='searchType == "2"'>
					u.user_Name like '%'|| #{searchWord} || '%'
				</if>
				<if test='searchType == "3"'>
					u.user_phone like '%'|| #{searchWord} || '%'
				</if>
			</if>
			<if test='minDate != "" and maxDate != ""'>
				AND
				s.shop_payment_date between to_date(replace(#{minDate},'-','')||'000000',
				'YYYYMMDDhh24miss')
				and to_date(replace(#{maxDate},'-','')||'235959','YYYYMMDDhh24miss')
			</if>
			<if test='minAmount != "" and maxAmount != ""'>
				AND
				s.shop_payment_price between TO_NUMBER(#{minAmount}) and TO_NUMBER(#{maxAmount})
			</if>
		</trim>
	</select>
	<select id="salePremiumList" parameterType="java.util.Map"
		resultType="com.dassa.vo.ShopPaymentVO">
		select a.* from
		(select
		s.shop_payment_idx as shopPaymentIdx,
		s.shop_payment_imp_uid as shopPaymentImpUid,
		s.shop_payment_merchant_uid as shopPaymentMerchantUid,
		s.shop_payment_method as shopPaymentPayMethod,
		s.shop_payment_pg as shopPaymentPg,
		s.shop_payment_pg_number as shopPaymentPgNumber,
		s.shop_payment_cardname as shopPaymentCardName,
		s.shop_payment_price as shopPaymentPrice,
		s.shop_payment_date as shopPaymentDate,
		s.shop_payment_last_date as shopPaymentLastDate,
		s.shop_payment_status as shopPaymentStatus,
		u.user_name as UserName,
		u.user_email as UserEmail,
		u.user_id as UserId,
		ROW_NUMBER() OVER(ORDER BY s.shop_payment_idx desc) rNUM
		from shop_payment_tbl s
		join user_tbl u on (s.user_idx = u.user_idx)
		<trim prefix="where" prefixOverrides="AND|OR">
			<if test='pagination.searchType != "" or pagination.searchWord != ""'>
				<if test='pagination.searchType == "1"'>
					u.user_id like '%'|| #{pagination.searchWord} || '%'
				</if>
				<if test='pagination.searchType == "2"'>
					u.user_Name like '%'|| #{pagination.searchWord} || '%'
				</if>
				<if test='pagination.searchType == "3"'>
					u.user_phone like '%'|| #{pagination.searchWord} || '%'
				</if>
			</if>
			<if test='pagination.minDate != "" and pagination.maxDate != ""'>
				AND
				s.shop_payment_date between to_date(replace(#{pagination.minDate},'-','')||'000000',
				'YYYYMMDDhh24miss')
				and to_date(replace(#{pagination.maxDate},'-','')||'235959','YYYYMMDDhh24miss')
			</if>
			<if test='pagination.minAmount != "" and pagination.maxAmount != ""'>
				AND
				s.shop_payment_price between TO_NUMBER(#{pagination.minAmount}) and TO_NUMBER(#{pagination.maxAmount})
			</if>
		</trim>
		) a
		where rNUM between #{start} and #{end}
		
	</select>
	<select id="manageSaleTotalCount"
		parameterType="com.dassa.vo.ManageSalePageData" resultType="_int">
		select count(*) as cnt from move_payment_tbl m
		join move_apply_tbl a on (m.apply_idx = a.apply_idx)
		join user_tbl u on(a.guest_idx = u.user_idx)
		<trim prefix="where" prefixOverrides="AND|OR">
			<if test='searchType != "" or searchWord != ""'>
				<if test='searchType == "1"'>
					u.user_id like '%'|| #{searchWord} || '%'
				</if>
				<if test='searchType == "2"'>
					u.user_Name like '%'|| #{searchWord} || '%'
				</if>
				<if test='searchType == "3"'>
					u.user_phone like '%'|| #{searchWord} || '%'
				</if>
			</if>
			<if test='minDate != "" and maxDate != ""'>
				AND
				m.Move_payment_date between to_date(replace(#{minDate},'-','')||'000000',
				'YYYYMMDDhh24miss')
				and to_date(replace(#{maxDate},'-','')||'235959','YYYYMMDDhh24miss')
			</if>
			<if test='minAmount != "" and maxAmount != ""'>
				AND
				m.move_payment_amount between TO_NUMBER(#{minAmount}) and TO_NUMBER(#{maxAmount})
			</if>
		</trim>
	</select>
	<select id="manageSaleMoveList" parameterType="java.util.Map"
		resultType="com.dassa.vo.MovePaymentVO">
		select a.* from
		(select
		m.move_payment_idx as movePaymentIdx,
		m.move_payment_imp_uid as movePaymentImpUid,
		m.move_payment_merchant_uid as movePaymentMerchantUid,
		m.move_payment_method as movePaymentPayMethod,
		m.move_payment_pg as movePaymentPg,
		m.move_payment_pg_number as movePaymentPgNumber,
		m.move_payment_cardname as movePaymentCardName,
		m.move_payment_amount as movePaymentAmount,
		m.move_payment_date as movePaymentDate,
		m.move_payment_cenceldate as movePaymentCencelDate,
		m.move_payment_status as movePaymentStatus,
		u.user_name as movePaymentUserName,
		u.user_email as movePaymentUserEmail,
		u.user_id as movePaymentUserId,
		ROW_NUMBER() OVER(ORDER BY m.move_payment_idx desc) rNUM
		from move_payment_tbl m
		join move_apply_tbl ma on (m.apply_idx = ma.apply_idx)
		join user_tbl u on (ma.guest_idx = u.user_idx)
		<trim prefix="where" prefixOverrides="AND|OR">
			<if test='pagination.searchType != "" or pagination.searchWord != ""'>
				<if test='pagination.searchType == "1"'>
					u.user_id like '%'|| #{pagination.searchWord} || '%'
				</if>
				<if test='pagination.searchType == "2"'>
					u.user_Name like '%'|| #{pagination.searchWord} || '%'
				</if>
				<if test='pagination.searchType == "3"'>
					u.user_phone like '%'|| #{pagination.searchWord} || '%'
				</if>
			</if>
			<if test='pagination.minDate != "" and pagination.maxDate != ""'>
				AND
				m.Move_payment_date between to_date(replace(#{pagination.minDate},'-','')||'000000',
				'YYYYMMDDhh24miss')
				and to_date(replace(#{pagination.maxDate},'-','')||'235959','YYYYMMDDhh24miss')
			</if>
			<if test='pagination.minAmount != "" and pagination.maxAmount != ""'>
				AND
				m.move_payment_amount between TO_NUMBER(#{pagination.minAmount}) and TO_NUMBER(#{pagination.maxAmount})
			</if>
		</trim>
		) a
		where rNUM between #{start} and #{end}


	</select>
	<select id="manageSaleMoveYearSum" parameterType="java.util.Map"
		resultType="com.dassa.vo.DriverSaleVO">
		SELECT to_char(move_payment_date,'yyyy') as driverSaledate,
		SUM(move_payment_amount*0.1) as driverSaleAmount
		FROM move_payment_tbl m
		join move_apply_tbl ma on (m.apply_idx = ma.apply_idx)
		join user_tbl u on (ma.guest_idx = u.user_idx)
		<trim prefix="where" prefixOverrides="AND|OR">
			<if test='pagination.searchType != "" or pagination.searchWord != ""'>
				<if test='pagination.searchType == "1"'>
					u.user_id like '%'|| #{pagination.searchWord} || '%'
				</if>
				<if test='pagination.searchType == "2"'>
					u.user_Name like '%'|| #{pagination.searchWord} || '%'
				</if>
				<if test='pagination.searchType == "3"'>
					u.user_phone like '%'|| #{pagination.searchWord} || '%'
				</if>
			</if>
			<if test='pagination.minDate != "" and pagination.maxDate != ""'>
				AND
				m.Move_payment_date between to_date(replace(#{pagination.minDate},'-','')||'000000',
				'YYYYMMDDhh24miss')
				and to_date(replace(#{pagination.maxDate},'-','')||'235959','YYYYMMDDhh24miss')
			</if>
			<if test='pagination.minAmount != "" and pagination.maxAmount != ""'>
				AND
				m.move_payment_amount between TO_NUMBER(#{pagination.minAmount}) and TO_NUMBER(#{pagination.maxAmount})
			</if>
		</trim>
		and move_payment_cenceldate is null
		GROUP BY to_char(move_payment_date,'yyyy') order by 1
	</select>
	<select id="manageSaleMoveMonthSum" parameterType="java.util.Map"
		resultType="com.dassa.vo.DriverSaleVO">
		SELECT to_char(move_payment_date,'yyyymm') as driverSaledate,
		SUM(move_payment_amount*0.1) as driverSaleAmount
		FROM move_payment_tbl m
		join move_apply_tbl ma on (m.apply_idx = ma.apply_idx)
		join user_tbl u on (ma.guest_idx = u.user_idx)
		<trim prefix="where" prefixOverrides="AND|OR">
			<if test='pagination.searchType != "" or pagination.searchWord != ""'>
				<if test='pagination.searchType == "1"'>
					u.user_id like '%'|| #{pagination.searchWord} || '%'
				</if>
				<if test='pagination.searchType == "2"'>
					u.user_Name like '%'|| #{pagination.searchWord} || '%'
				</if>
				<if test='pagination.searchType == "3"'>
					u.user_phone like '%'|| #{pagination.searchWord} || '%'
				</if>
			</if>
			<if test='pagination.minDate != "" and pagination.maxDate != ""'>
				AND
				m.Move_payment_date between to_date(replace(#{pagination.minDate},'-','')||'000000',
				'YYYYMMDDhh24miss')
				and to_date(replace(#{pagination.maxDate},'-','')||'235959','YYYYMMDDhh24miss')
			</if>
			<if test='pagination.minAmount != "" and pagination.maxAmount != ""'>
				AND
				m.move_payment_amount between TO_NUMBER(#{pagination.minAmount}) and TO_NUMBER(#{pagination.maxAmount})
			</if>
		</trim>
		and move_payment_cenceldate is null
		GROUP BY to_char(move_payment_date,'yyyymm') order by 1
	</select>
</mapper>
